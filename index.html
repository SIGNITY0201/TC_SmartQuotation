<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERRACASA ìŠ¤ë§ˆíŠ¸ í†µí•© ê²¬ì  ì‹œìŠ¤í…œ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas (ì´ë¯¸ì§€ ìº¡ì²˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF (PDF ìƒì„±) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tc-black': '#1a1a1a',
                        'tc-white': '#ffffff',
                        'tc-gray': '#333333',
                        'tc-olive': '#4A5D23', /* í…Œë¼ê¹Œì‚¬ ì˜¬ë¦¬ë¸Œ ê·¸ë¦° */
                        'tc-yellow': '#EAB308', /* í…Œë¼ê¹Œì‚¬ ì˜ë¡œìš° (í¬ì¸íŠ¸) */
                        'tc-light': '#F9FAFB',
                    },
                    fontFamily: {
                        sans: ['Pretendard', 'Noto Sans KR', 'sans-serif'],
                    },
                    screens: {
                        'print': {'raw': 'print'},
                    }
                }
            }
        };
    </script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }

        .force-hidden { display: none !important; }

        .app-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .capture-area {
            padding: 40px;
            background-color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 1400px;
        }
        
        @media (max-width: 768px) {
            .capture-area { padding: 20px; }
        }

        .input-base {
            width: 100%;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.2s;
            background-color: #fff;
            height: 32px;
        }
        .input-base:focus {
            outline: none;
            border-color: #4A5D23;
            box-shadow: 0 0 0 1px rgba(74, 93, 35, 0.3);
        }
        select.input-base { padding-right: 20px; }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }
        
        .excel-table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
            border: 1px solid #9ca3af;
            font-size: 12px;
        }
        .excel-table th {
            background-color: #f3f4f6;
            border: 1px solid #9ca3af;
            padding: 8px;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
            color: #4A5D23;
        }
        .excel-table td {
            border: 1px solid #d1d5db;
            padding: 4px;
            height: auto;
            vertical-align: middle;
        }
        .excel-input {
            width: 100%;
            height: 100%;
            min-height: 32px;
            border: none;
            padding: 0 4px;
            background: transparent;
            outline: none;
            font-size: 12px;
        }
        .excel-input:focus { background-color: #fefce8; }
        
        .section-header {
            background-color: #4A5D23;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 14px;
            margin-top: 20px;
            border-radius: 4px 4px 0 0;
            border-bottom: 3px solid #EAB308;
        }

        .spec-container, .option-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 11px;
        }
        .spec-row, .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .spec-label { width: 30px; color: #666; font-weight: 600; }
        .spec-input { flex: 1; border-bottom: 1px solid #ddd; padding: 2px; }
        
        .option-label { display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 2px 0; }
        .option-qty-input {
            width: 30px; border: 1px solid #ddd; border-radius: 3px; text-align: center; padding: 2px; background-color: white;
        }
        .option-qty-input:disabled { background-color: #f3f4f6; color: #9ca3af; border: 1px solid #e5e7eb; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10000;
        }
        .hidden { display: none !important; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #4A5D23;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .notice-box {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }
        .notice-title {
            font-weight: 800; color: #4A5D23; margin-bottom: 0.5rem; font-size: 0.85rem;
        }
        .notice-list {
            font-size: 0.7rem; color: #6b7280; line-height: 1.5;
            display: flex; flex-direction: column; gap: 3px;
        }
        .notice-item { display: flex; align-items: flex-start; }
        .notice-bullet { margin-right: 6px; color: #EAB308; font-weight: bold; min-width: 8px; }

        #pdf-hidden-container {
            position: fixed;
            left: 0; top: 0; width: 1200px; height: 0;
            overflow: visible; z-index: -9999; opacity: 0; pointer-events: none;
        }

        .pdf-mode .input-base, 
        .pdf-mode .excel-input, 
        .pdf-mode select, 
        .pdf-mode .spec-input, 
        .pdf-mode .option-qty-input, 
        .pdf-mode .discount-input {
            border: none !important;
            border-bottom: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0 !important;
            -webkit-appearance: none; 
            appearance: none;
        }
        .pdf-mode .hidden-on-print { display: none !important; }
        .pdf-mode textarea { resize: none; border: none; }
        .pdf-mode .section-header { background-color: #4A5D23; color: white; border-bottom: 3px solid #EAB308; }
        .pdf-mode .excel-table th { color: #4A5D23; background-color: #f3f4f6; }
        
        .discount-text {
            color: #4A5D23; /* ì˜¬ë¦¬ë¸Œ ê·¸ë¦° */
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 6px;
            line-height: 1.4;
        }
        .warning-text {
            color: #dc2626;
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 6px;
            line-height: 1.4;
            background-color: #fef2f2;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #fecaca;
        }
        
        .btn-olive { background-color: #4A5D23; color: white; }
        .btn-olive:hover { background-color: #3a4a1c; }
    </style>
</head>
<body class="bg-gray-50 py-4 px-2 md:py-10 md:px-4">

    <!-- ë¡œë”© -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div class="text-center font-bold text-lg text-tc-olive">ê²¬ì ì„œ PDF ìƒì„± ì¤‘...</div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="w-full max-w-[1200px] mx-auto mb-6 flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border-l-4 border-tc-olive">
        <h1 class="text-xl font-bold text-tc-olive">TERRACASA í†µí•© ê²¬ì ì„œ</h1>
        <button onclick="location.reload()" class="text-sm text-gray-400 hover:text-tc-olive underline transition">ì´ˆê¸°í™”</button>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="app-container rounded-lg overflow-hidden">
        
        <div id="capture-area" class="capture-area">
            <!-- í—¤ë”: ê°€ìš´ë° ì •ë ¬ -->
            <div class="text-center mb-8 pb-6 border-b-2 border-tc-olive">
                <span class="text-sm font-bold text-tc-olive tracking-[0.4em] uppercase mb-2 block">Work with Smart Consumers!</span>
                <h1 class="text-5xl font-black text-black tracking-tight">TERRACASA QUOTATION</h1>
            </div>

            <div class="flex flex-col md:flex-row border border-gray-300 mb-8 rounded-sm overflow-hidden">
                <!-- ê³µê¸‰ì ì •ë³´ -->
                <div class="w-full md:w-1/2 p-6 border-b md:border-b-0 md:border-r border-gray-300">
                    <h3 class="font-extrabold text-tc-olive mb-4 text-xs uppercase tracking-wider">Supplier (ê³µê¸‰ì)</h3>
                    <div class="grid grid-cols-[70px_1fr] gap-y-2 text-sm text-gray-700">
                        <div class="text-gray-400 font-medium">ìƒí˜¸</div>
                        <div>
                            <div class="font-bold text-lg text-black" id="supplier-name">(ì£¼)ì‹œê·¸ë‹ˆí‹°</div>
                            <div class="text-xs text-gray-400 mt-1" id="supplier-biz-no">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ : 524-81-02411</div>
                        </div>
                        <div class="text-gray-400 font-medium">ë‹´ë‹¹ì</div><div class="font-bold" id="supplier-manager">ìµœì¬í›ˆ</div>
                        <div class="text-gray-400 font-medium">ì—°ë½ì²˜</div><div class="font-bold" id="supplier-phone">1800-9512 / 010-8132-9047</div>
                        <div class="text-gray-400 font-medium">ì´ë©”ì¼</div><div id="supplier-email">Terracasa_@naver.com</div>
                    </div>
                </div>
                <!-- ê³ ê° ì •ë³´ -->
                <div class="w-full md:w-1/2 p-6 bg-[#FAFAFA]">
                    <h3 class="font-extrabold text-tc-olive mb-4 text-xs uppercase tracking-wider">Customer (ë°œì£¼ì)</h3>
                    <div class="grid grid-cols-[70px_1fr] gap-y-3 text-sm items-center">
                        <div class="text-tc-olive font-bold">ê²¬ì ì¼</div>
                        <div id="view-date" class="text-base font-bold text-black border-b border-gray-300 pb-1 w-full"></div>

                        <div class="text-gray-500 font-semibold">ì„±í•¨</div>
                        <input type="text" id="cust-name" class="input-base font-bold bg-white" placeholder="ê³ ê°ëª… (ë¯¸ì…ë ¥ì‹œ VIP)">
                        
                        <div class="text-gray-500 font-semibold">ì—°ë½ì²˜</div>
                        <input type="text" id="cust-phone" class="input-base bg-white" placeholder="010-0000-0000" type="tel">
                        
                        <div class="text-gray-500 font-semibold self-start mt-1">ì£¼ì†Œ</div>
                        <div class="flex flex-col gap-1 w-full">
                            <div class="flex gap-1 w-full">
                                <select id="region-do" class="input-base w-1/2 bg-white" onchange="handleRegionChange(this)"><option value="">ì‹œ/ë„</option></select>
                                <select id="region-si" class="input-base w-1/2 bg-white" disabled><option value="">ì‹œ/êµ°/êµ¬</option></select>
                            </div>
                            <input type="text" id="cust-addr-detail" class="input-base bg-white" placeholder="ìƒì„¸ì£¼ì†Œ">
                        </div>

                        <div class="text-gray-500 font-semibold">ì„¤ì¹˜ì¼</div>
                        <input type="date" id="install-date" class="input-base bg-white">
                    </div>
                </div>
            </div>

            <!-- ëª¨ë°”ì¼ ì•ˆë‚´ -->
            <div class="md:hidden text-xs text-tc-yellow font-bold mb-1 text-right">â†” ì¢Œìš°ë¡œ ë°€ì–´ì„œ í™•ì¸</div>

            <div class="section-header">1. ì œí’ˆ ìƒì„¸ ë‚´ì—­ (Product Details)</div>
            <div class="mb-4">
                <div class="table-wrapper">
                    <table class="excel-table">
                        <colgroup><col width="40"><col width="160"><col width="140"><col width="80"><col width="160"><col width="40"><col width="40"><col width="90"><col width="100"><col width="40" class="hidden-on-print"></colgroup>
                        <thead><tr><th>No.</th><th>í’ˆëª…</th><th>ê·œê²©</th><th>ìƒ‰ìƒ</th><th>ì˜µì…˜ (ì¶”ê°€ì‚¬í•­)</th><th>ë‹¨ìœ„</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ê³µê¸‰ê°€ì•¡</th><th class="hidden-on-print">ì‚­ì œ</th></tr></thead>
                        <tbody id="est-tbody"></tbody>
                    </table>
                </div>
                <div class="text-center py-3 bg-gray-50 border border-t-0 border-gray-300 hidden-on-print rounded-b"><button onclick="addRow()" class="text-xs font-bold text-tc-olive hover:underline py-1 w-full block">+ ì œí’ˆ ì¶”ê°€</button></div>
            </div>

            <div class="section-header">2. ì‹œê³µ ë° ê¸°íƒ€ ë¶€ëŒ€ë¹„ìš© (Construction & Others)</div>
            <div class="mb-6">
                <div class="table-wrapper">
                    <table class="excel-table" id="construction-table">
                        <colgroup><col width="120"><col width="180"><col width="180"><col width="40"><col width="40"><col width="110"><col width="110"><col width="40" class="hidden-on-print"></colgroup>
                        <thead><tr><th>êµ¬ë¶„</th><th>í•­ëª©ëª…</th><th>ìƒì„¸ë‚´ìš©</th><th>ë‹¨ìœ„</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ê³µê¸‰ê°€ì•¡</th><th class="hidden-on-print">ì‚­ì œ</th></tr></thead>
                        <tbody id="cons-tbody"></tbody>
                    </table>
                </div>
                <div class="text-center py-3 bg-gray-50 border border-t-0 border-gray-300 hidden-on-print flex flex-col md:flex-row justify-center gap-2 rounded-b px-4 flex-wrap">
                    <button onclick="addGenericDirectConsRow()" class="text-xs font-bold text-tc-olive hover:text-green-800 underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ì§ì ‘ê³µì‚¬ë¹„</button>
                    <button onclick="addFoundationRow()" class="text-xs font-bold text-gray-600 hover:text-black underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ì§ì ‘ê³µì‚¬ë¹„(ê¸°ì´ˆ)</button>
                    <button onclick="addMeasurementRow()" class="text-xs font-bold text-tc-yellow hover:text-yellow-700 underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ì§ì ‘ê³µì‚¬ë¹„(ì‹¤ì¸¡)</button>
                    <button onclick="addLiftingRow()" class="text-xs font-bold text-gray-500 hover:text-gray-800 underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ìì¬ë°˜ì…ë¹„(ì–‘ì¤‘)</button>
                    <button onclick="addDeckRow()" class="text-xs font-bold text-teal-600 hover:text-teal-800 underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ìì²´ê³µì‚¬ë¹„(ë°í¬)</button>
                    <button onclick="addIndirectConsRow()" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ê°„ì ‘ê³µì‚¬ë¹„</button>
                    <button onclick="addConsRow()" class="text-xs font-bold text-gray-500 hover:text-gray-800 underline py-1 border border-gray-300 rounded bg-white px-3 shadow-sm">+ ê¸°íƒ€ í•­ëª©</button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6 mb-8">
                <div class="w-full lg:w-2/3">
                    <div class="border border-gray-300 rounded p-4 h-full bg-white relative shadow-sm">
                        <h4 class="text-xs font-bold text-tc-olive mb-3">NOTE / REMARKS (íŠ¹ì´ì‚¬í•­)</h4>
                        <textarea id="remarks-area" class="w-full h-24 md:h-32 border-none text-xs resize-none focus:outline-none text-gray-700 leading-relaxed" placeholder="ë‚©ê¸°ì¼, ë°°ì†¡ ì¡°ê±´, í˜„ì¥ íŠ¹ì´ì‚¬í•­ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        <div id="discount-message-area" class="mt-3 border-t pt-2 border-gray-100 space-y-2"></div>
                    </div>
                </div>
                <div class="w-full lg:w-1/3">
                    <table class="w-full text-xs border-collapse">
                        <tr class="border-b border-gray-200"><td class="py-2 text-gray-500">ì œí’ˆ í•©ê³„</td><td class="py-2 text-right font-medium text-gray-700" id="val-prod-sum">0</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 text-gray-500">ì‹œê³µ/ê¸°íƒ€ í•©ê³„</td><td class="py-2 text-right font-medium text-gray-700" id="val-cons-sum">0</td></tr>
                        <tr class="border-b border-gray-200 bg-gray-50"><td class="py-2 font-bold text-gray-700 pl-2">ì´ ê³µê¸‰ê°€ì•¡</td><td class="py-2 text-right font-bold pr-2" id="val-supply">0</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 text-gray-500 pl-2">ë¶€ê°€ì„¸ (VAT)</td><td class="py-2 text-right font-medium pr-2" id="val-tax">0</td></tr>
                        <tr class="bg-gray-100 border-t-2 border-tc-olive"><td class="py-3 pl-3 font-bold text-lg text-black">ì´ ê²¬ì ê¸ˆì•¡</td><td class="py-3 pr-3 text-right font-black text-2xl text-tc-olive">â‚© <span id="val-total">0</span></td></tr>
                    </table>
                </div>
            </div>

            <!-- í•˜ë‹¨ ìœ ì˜ì‚¬í•­ -->
            <div class="notice-box">
                <h4 class="notice-title">[ê°€ê²¬ì  ìœ ì˜ì‚¬í•­ ë° íŠ¹ì•½ì„¤ëª…]</h4>
                <div class="notice-list">
                    <div class="notice-item"><span class="notice-bullet">*</span><span>í…Œë¼ê¹Œì‚¬ëŠ” ì§€ì—­ë³„ë¡œ ë‹¤ë¥¸ ìš´ì˜ì‚¬ì— ì˜í•´ ìš´ì˜ë˜ëŠ” ìµìŠ¤í…Œë¦¬ì–´ ì „ë¬¸ ë¸Œëœë“œì…ë‹ˆë‹¤</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>í…Œë¼ê¹Œì‚¬ëŠ” êµ­ë‚´ ìµœì € ìˆ˜ì¤€ì˜ ê°€ê²©ì„ ì¶”êµ¬í•©ë‹ˆë‹¤. ë°œì£¼ì™€ ë™ì‹œì— ë°œì£¼ì²˜ì— ì œí’ˆê°€ì•¡ì„ ì „ì•¡ ì§€ë¶ˆí•¨ìœ¼ë¡œ ê³„ì•½ì‹œ ì œí’ˆê°€ì•¡ ì™„ë‚©ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>í…Œë¼ê¹Œì‚¬ëŠ” ì œí’ˆíŒë§¤ê°€ ì¤‘ì‹¬ì¸ íšŒì‚¬ë¡œ, ê°ë¦¬ë¹„ ë° í˜„ì¥ê´€ë¦¬ë¹„ ì—†ì´ íš¨ìœ¨ì ì¸ ì§„í–‰ì„ ìœ„í•´ ì œí’ˆ ë°œì£¼ í›„ ì‹œê³µ ì—…ë¬´ëŠ” ì „ë¬¸ ì‹œê³µíŒ€ì— ì „ì ìœ¼ë¡œ ìœ„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì¶”í›„ ê³„ì•½ì‹œ ì‹œê³µì‚¬ì—…ìì™€ ì§ê³„ì•½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì‹œê³µë¹„ëŠ” ì œí’ˆë¹„ì™€ ë³„ë„ ì •ì‚°ë˜ë©°, ì…ê¸ˆ ê³„ì¢Œ ì—­ì‹œ ì‹œê³µíŒ€ ì „ìš© ê³„ì¢Œë¡œ êµ¬ë¶„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ëŒ€ê¸ˆ ì§€ê¸‰ì´ ì¼ê´„ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” ê²½ìš°ì—ë„ ë³„ë„ì˜ ê°ë¦¬ë¹„ ë° í˜„ì¥ê´€ë¦¬ë¹„ ì§€ê¸‰ì´ ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ë°œì£¼ ì´í›„ ì‹œê³µ ê´€ë ¨ ì±…ì„ì€ ì „ì ìœ¼ë¡œ ì‹œê³µíŒ€ì— ê·€ì†ë©ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì‹œê³µë¹„ëŠ” ì‹œê³µ ë‹¹ì¼ ì‹œê³µì™„ë£Œ í›„ ì¦‰ì‹œ ì§€ê¸‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì²­êµ¬ë˜ëŠ” ì‹œê³µë¹„ì˜ ê²½ìš° ê¸°ë³¸ ì‹œê³µë¹„ë¡œ í˜„ì¥ ì—¬ê±´ì— ë”°ë¼ ì¶”ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>í˜„ì¥ íŠ¹ì„± ìƒ ì£¼ì¶§ëŒì´ë‚˜ ëª°íƒˆ ë“±ì˜ ì§€ë°˜ ì¶”ê°€ ì‘ì—… í•„ìš” ì‹œ 200,000ì› ì¶”ê°€ ë¹„ìš© ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì „ë™ ì‹œê³µì‹œ ì „ì„ ì´ íŒŒê³ ë¼ ì„¤ì¹˜ì•„ë˜ê¹Œì§€ ë‚˜ì™€ìˆì§€ ì•Šì€ê²½ìš° ì „ê¸° ì—°ì¥ë¹„ìš©ì´ 200,000ì› ì¶”ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>í˜„ì¥ ë°˜ì… ì´ìŠˆ ë°œìƒì‹œ ì–‘ì¤‘ ë¹„ìš© ì¶”ê°€ ë°œìƒ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ê±´ì„¤í˜„ì¥ ì‚¬ë‹¤ë¦¬ ë³´ì¡°ì˜ ê²½ìš° ê²¬ì ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šìœ¼ë‹ˆ í•„ìš”í•œ í˜„ì¥ì˜ ê²½ìš° ë³„ë„ ìš”ì²­ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì‚¬ì „ í˜‘ì˜ë˜ì§€ ì•Šì€ í˜„ì¥ ë³€ë™ìœ¼ë¡œ ì¸í•œ ì‹œê³µ ì¶”ê°€ê¸ˆì•¡ì€ ë³„ë„ë¡œ ì²­êµ¬ë©ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì–‘ì¤‘ë¹„ì˜ ê²½ìš° ì²­êµ¬ê¸ˆì•¡ì´ ì´ˆê³¼ë˜ëŠ” ê²½ìš° ì¶”ê°€ ì²­êµ¬ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ë¶€ë“ì´í•˜ê²Œ ì‹œê³µë¹„ì˜ ì¼ê´„ ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤ë©´(ê´€ê³µì„œ, ê±´ì„¤ì‚¬ ë“±) ë³„ë„ì˜ â€œí†µí•© ê²¬ì ì„œâ€ë¥¼ ìš”ì²­ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì„œìš¸ ê²½ê¸° ì™¸ ì¶œì¥ë¹„ê°€ ì¶”ê°€ë˜ë©° ë„ì„œ ì‚°ê°„ì˜ ê²½ìš° ì¶”ê°€ ì¶œì¥ë¹„ê°€ ë°œìƒ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ê¸€ë¼ìŠ¤ìŠ¬ë¼ì´ë”©ì˜ ê²½ìš° ìµœì†Œ ì‹œê³µë¹„ 60ë§Œì›ì´ ê¸°ë³¸ìœ¼ë¡œ ë°œìƒí•˜ë©° 9ì§ ë¶€í„°ëŠ” 1ì§ë‹¹ 7ë§Œì›ì˜ ì‹œê³µë¹„ê°€ ë°œìƒí•©ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>Deck(ë°í¬) ê³µì‚¬ì˜ ê²½ìš° ë‹¹ì‚¬ì˜ ì œí’ˆí’ˆëª©ì´ ì•„ë‹Œ ì‹œê³µíŒ€ì˜ ë³„ë„ ì„œë¹„ìŠ¤ í’ˆëª©ì„ìœ¼ë¡œ ë‹¹ì‚¬ ì œí’ˆ ê³µì‚¬ì™€ëŠ” ë¬´ê´€í•©ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ì¥ë°”ì˜ ìì—°ìŠ¤ëŸ¬ìš´ ì²˜ì§ í˜„ìƒì€ ì œí’ˆ í•˜ìë¡œ ì ‘ìˆ˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ê²¬ì ì¤‘ ìˆ˜ì‹ì´ ì•ˆê±¸ë ¤ìˆê±°ë‚˜, ì˜¤ê¸°ë¡œ ì¸í•œ ê²¬ì ì°©ì˜¤ëŠ” í–¥í›„ ë°˜ì˜ ë ìˆ˜ ìˆì‚¬ì˜¤ë‹ˆ ì ê·¹ ê²€í†  ë¶€íƒë“œë¦½ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ê²¬ì ìœ íš¨ê¸°ê°„ ì´í›„ ë°˜ì˜ë˜ëŠ” ë‹¨ê°€ ì¸ìƒì€ ì†Œê¸‰ì ìš©í•˜ê¸° ì–´ë ¤ìš°ë‹ˆ ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</span></div>
                    <div class="notice-item"><span class="notice-bullet">*</span><span>ê²¬ì  ìœ íš¨ê¸°ê°„ì€ 2ì£¼ì…ë‹ˆë‹¤.</span></div>
                </div>
            </div>

            <!-- Footer: ID added for dynamic update -->
            <div id="footer-info" class="mt-8 text-center text-xs text-gray-400 pb-4">(ì£¼)ì‹œê·¸ë‹ˆí‹° | ë‹´ë‹¹ì: ìµœì¬í›ˆ | ì—°ë½ì²˜: 010-8132-9047</div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 flex justify-center gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
        <button onclick="saveAsPDF()" class="btn-olive font-bold py-3 px-10 rounded-full shadow-lg text-lg flex items-center justify-center gap-2 hover:scale-105 transition transform">
            <span>ğŸ’¾ PDF ê²¬ì ì„œ ì €ì¥</span>
        </button>
    </div>
    
    <!-- PDF ìƒì„±ì„ ìœ„í•œ ìˆ¨ê²¨ì§„ ì»¨í…Œì´ë„ˆ -->
    <div id="pdf-hidden-container"></div>

    <script>
        // --- 1. ë°ì´í„° ---
        const regions = {'ì„œìš¸íŠ¹ë³„ì‹œ':['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],'ë¶€ì‚°ê´‘ì—­ì‹œ':['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬','í•´ìš´ëŒ€êµ¬'],'ëŒ€êµ¬ê´‘ì—­ì‹œ':['êµ°ìœ„êµ°','ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬'],'ì¸ì²œê´‘ì—­ì‹œ':['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¯¸ì¶”í™€êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì˜¹ì§„êµ°','ì¤‘êµ¬'],'ê´‘ì£¼ê´‘ì—­ì‹œ':['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],'ëŒ€ì „ê´‘ì—­ì‹œ':['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],'ìš¸ì‚°ê´‘ì—­ì‹œ':['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°','ì¤‘êµ¬'],'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':['ì„¸ì¢…ì‹œ'],'ê²½ê¸°ë„':['ê°€í‰êµ°','ê³ ì–‘ì‹œ','ê³¼ì²œì‹œ','ê´‘ëª…ì‹œ','ê´‘ì£¼ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ê¹€í¬ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ë™ë‘ì²œì‹œ','ë¶€ì²œì‹œ','ì„±ë‚¨ì‹œ','ìˆ˜ì›ì‹œ','ì‹œí¥ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì„±ì‹œ','ì•ˆì–‘ì‹œ','ì–‘ì£¼ì‹œ','ì–‘í‰êµ°','ì—¬ì£¼ì‹œ','ì—°ì²œêµ°','ì˜¤ì‚°ì‹œ','ìš©ì¸ì‹œ','ì˜ì™•ì‹œ','ì˜ì •ë¶€ì‹œ','ì´ì²œì‹œ','íŒŒì£¼ì‹œ','í‰íƒì‹œ','í¬ì²œì‹œ','í•˜ë‚¨ì‹œ','í™”ì„±ì‹œ'],'ê°•ì›íŠ¹ë³„ìì¹˜ë„':['ê°•ë¦‰ì‹œ','ê³ ì„±êµ°','ë™í•´ì‹œ','ì‚¼ì²™ì‹œ','ì†ì´ˆì‹œ','ì–‘êµ¬êµ°','ì–‘ì–‘êµ°','ì˜ì›”êµ°','ì›ì£¼ì‹œ','ì¸ì œêµ°','ì •ì„ êµ°','ì² ì›êµ°','ì¶˜ì²œì‹œ','íƒœë°±ì‹œ','í‰ì°½êµ°','í™ì²œêµ°','í™”ì²œêµ°','íš¡ì„±êµ°'],'ì¶©ì²­ë¶ë„':['ê´´ì‚°êµ°','ë‹¨ì–‘êµ°','ë³´ì€êµ°','ì˜ë™êµ°','ì˜¥ì²œêµ°','ìŒì„±êµ°','ì œì²œì‹œ','ì¦í‰êµ°','ì§„ì²œêµ°','ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ'],'ì¶©ì²­ë‚¨ë„':['ê³„ë£¡ì‹œ','ê³µì£¼ì‹œ','ê¸ˆì‚°êµ°','ë…¼ì‚°ì‹œ','ë‹¹ì§„ì‹œ','ë³´ë ¹ì‹œ','ë¶€ì—¬êµ°','ì„œì‚°ì‹œ','ì„œì²œêµ°','ì•„ì‚°ì‹œ','ì˜ˆì‚°êµ°','ì²œì•ˆì‹œ','ì²­ì–‘êµ°','íƒœì•ˆêµ°','í™ì„±êµ°'],'ì „ë¶íŠ¹ë³„ìì¹˜ë„':['ê³ ì°½êµ°','êµ°ì‚°ì‹œ','ê¹€ì œì‹œ','ë‚¨ì›ì‹œ','ë¬´ì£¼êµ°','ë¶€ì•ˆêµ°','ìˆœì°½êµ°','ì™„ì£¼êµ°','ìµì‚°ì‹œ','ì„ì‹¤êµ°','ì¥ìˆ˜êµ°','ì „ì£¼ì‹œ','ì •ìì‹œ','ì§„ì•ˆêµ°'],'ì „ë¼ë‚¨ë„':['ê°•ì§„êµ°','ê³ í¥êµ°','ê³¡ì„±êµ°','ê´‘ì–‘ì‹œ','êµ¬ë¡€êµ°','ë‚˜ì£¼ì‹œ','ë‹´ì–‘êµ°','ëª©í¬ì‹œ','ë¬´ì•ˆêµ°','ë³´ì„±êµ°','ìˆœì²œì‹œ','ì‹ ì•ˆêµ°','ì—¬ìˆ˜ì‹œ','ì˜ê´‘êµ°','ì˜ì•”êµ°','ì™„ë„êµ°','ì¥ì„±êµ°','ì¥í¥êµ°','ì§„ë„êµ°','í•¨í‰êµ°','í•´ë‚¨êµ°','í™”ìˆœêµ°'],'ê²½ìƒë¶ë„':['ê²½ì‚°ì‹œ','ê²½ì£¼ì‹œ','ê³ ë ¹êµ°','êµ¬ë¯¸ì‹œ','ê¹€ì²œì‹œ','ë¬¸ê²½ì‹œ','ë´‰í™”êµ°','ìƒì£¼ì‹œ','ì„±ì£¼êµ°','ì•ˆë™ì‹œ','ì˜ë•êµ°','ì˜ì–‘êµ°','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','ì˜ˆì²œêµ°','ìš¸ë¦‰êµ°','ìš¸ì§„êµ°','ì˜ì„±êµ°','ì²­ë„êµ°','ì²­ì†¡êµ°','ì¹ ê³¡êµ°','í¬í•­ì‹œ'],'ê²½ìƒë‚¨ë„':['ê±°ì œì‹œ','ê±°ì°½êµ°','ê³ ì„±êµ°','ê¹€í•´ì‹œ','ë‚¨í•´êµ°','ë°€ì–‘ì‹œ','ì‚¬ì²œì‹œ','ì‚°ì²­êµ°','ì–‘ì‚°ì‹œ','ì˜ë ¹êµ°','ì§„ì£¼ì‹œ','ì°½ë…•êµ°','ì°½ì›ì‹œ','í†µì˜ì‹œ','í•˜ë™êµ°','í•¨ì•ˆêµ°','í•¨ì–‘êµ°','í•©ì²œêµ°'],'ì œì£¼íŠ¹ë³„ìì¹˜ë„':['ì„œê·€í¬ì‹œ','ì œì£¼ì‹œ']};

        // ê³µê¸‰ì ì •ë³´ ì„¤ì •
        const suppliers = {
            default: {
                name: '(ì£¼)ì‹œê·¸ë‹ˆí‹°',
                bizNo: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ : 524-81-02411',
                manager: 'ìµœì¬í›ˆ',
                phone: '1800-9512 / 010-8132-9047',
                email: 'Terracasa_@naver.com'
            },
            gyeongsang: {
                name: 'í´ë¡œë“œ ë””',
                bizNo: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ : 502-40-44290', // ìš”ì²­í•˜ì‹  ì‚¬ì—…ì ë²ˆí˜¸ ë°˜ì˜
                manager: 'ê³½ëª…í¬',
                phone: '010-6277-0339',
                email: 'claudedesignlab@naver.com'
            }
        };

        const gyeongsangArea = ['ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„'];

        // ì œí’ˆ ì¹´í…Œê³ ë¦¬ ì •ì˜
        const productCategories = [
            {
                label: "System Pergola",
                items: ["OASIS (ìˆ˜ë™)", "OASIS (ì „ë™)"]
            },
            {
                label: "Glass",
                items: ["Glass Sliding", "Fix Glass"]
            },
            {
                label: "Deck",
                items: ["ìŠ¤í†¤ë°í¬ (+í˜ë°ìŠ¤íƒˆ)", "ìŠ¤í†¤ë°í¬ (+ê°ê´€)"]
            },
            {
                label: "ê¸°íƒ€",
                items: ["ì§ì ‘ ì…ë ¥"]
            }
        ];

        // --- OASIS ë‹¨ê°€í‘œ ---
        const oasisManualPriceTable = {
            2600: [3200000, 3400000, 3600000, 3800000, 4000000, 4200000, 4400000],
            2775: [3240000, 3450000, 3660000, 3870000, 4080000, 4290000, 4500000],
            2950: [3280000, 3500000, 3720000, 3940000, 4160000, 4380000, 4600000],
            3125: [3320000, 3550000, 3780000, 4010000, 4240000, 4470000, 4700000],
            3300: [3360000, 3600000, 3840000, 4080000, 4320000, 4560000, 4800000],
            3475: [3400000, 3650000, 3900000, 4150000, 4400000, 4650000, 4900000],
            3650: [3440000, 3700000, 3960000, 4220000, 4480000, 4740000, 5000000],
            3825: [3480000, 3750000, 4020000, 4290000, 4560000, 4830000, 5100000],
            4000: [3520000, 3800000, 4080000, 4360000, 4640000, 4920000, 5200000],
            4175: [3560000, 3850000, 4140000, 4430000, 4720000, 5010000, 5300000],
            4350: [3600000, 3900000, 4200000, 4500000, 4800000, 5100000, 5400000],
            4525: [3640000, 3950000, 4260000, 4570000, 4880000, 5190000, 5500000],
            4700: [3680000, 4000000, 4320000, 4640000, 4960000, 5280000, 5600000],
            4875: [3720000, 4050000, 4380000, 4710000, 5040000, 5370000, 5700000],
            5050: [3760000, 4100000, 4440000, 4780000, 5120000, 5460000, 5800000],
            5225: [3800000, 4150000, 4500000, 4850000, 5200000, 5550000, 5900000],
            5400: [3840000, 4200000, 4560000, 4920000, 5280000, 5640000, 6000000]
        };

        const oasisElectricPriceTable = {
            2600: [3600000, 3850000, 4100000, 4350000, 4600000, 4850000, 5100000],
            2775: [3640000, 3900000, 4160000, 4420000, 4680000, 4940000, 5200000],
            2950: [3680000, 3950000, 4220000, 4490000, 4760000, 5030000, 5300000],
            3125: [3720000, 4000000, 4280000, 4560000, 4840000, 5120000, 5400000],
            3300: [3760000, 4050000, 4340000, 4630000, 4920000, 5210000, 5500000],
            3475: [3800000, 4100000, 4400000, 4700000, 5000000, 5300000, 5600000],
            3650: [3840000, 4150000, 4460000, 4770000, 5080000, 5390000, 5700000],
            3825: [3880000, 4200000, 4520000, 4840000, 5160000, 5480000, 5800000],
            4000: [3920000, 4250000, 4580000, 4910000, 5240000, 5570000, 5900000],
            4175: [3960000, 4300000, 4640000, 4980000, 5320000, 5660000, 6000000],
            4350: [4000000, 4350000, 4700000, 5050000, 5400000, 5750000, 6100000],
            4525: [4040000, 4400000, 4760000, 5120000, 5480000, 5840000, 6200000],
            4700: [4080000, 4450000, 4820000, 5190000, 5560000, 5930000, 6300000],
            4875: [4120000, 4500000, 4880000, 5260000, 5640000, 6020000, 6400000],
            5050: [4160000, 4550000, 4940000, 5330000, 5720000, 6110000, 6500000],
            5225: [4200000, 4600000, 5000000, 5400000, 5800000, 6200000, 6600000],
            5400: [4240000, 4650000, 5060000, 5470000, 5880000, 6290000, 6700000],
            5575: [4280000, 4700000, 5120000, 5540000, 5960000, 6380000, 6800000],
            5750: [4320000, 4750000, 5180000, 5610000, 6040000, 6470000, 6900000],
            5925: [4360000, 4800000, 5240000, 5680000, 6120000, 6560000, 7000000]
        };

        const stayManualPivots = Object.keys(oasisManualPriceTable).map(Number);
        const stayElectricPivots = Object.keys(oasisElectricPriceTable).map(Number);
        
        // ê¸°ë³¸ ë¹„ìš© í•­ëª© - ì–‘ì¤‘ë¹„, ê°„ì ‘ê³µì‚¬ë¹„ ì œê±°
        const defaultConsItems = [
            { cat: "ì§ì ‘ ê³µì‚¬ë¹„", name: "ê²½ë¹„", spec: "ì¶œì¥ë¹„", price: 200000 },
            { cat: "ìì¬ ë°˜ì…ë¹„", name: "ìš´ì„", spec: "í™”ë¬¼ë¹„" }
        ];

        function getSpanIndex(span) {
            if (span <= 1000) return 0; if (span <= 1500) return 1; if (span <= 2000) return 2; if (span <= 2500) return 3; if (span <= 3000) return 4; if (span <= 3500) return 5; if (span <= 4000) return 6; return -1;
        }

        function calculatePergolaPrice(model, type, span, pivotVal) {
            const sIdx = getSpanIndex(span); 
            if (sIdx === -1) return 0;
            
            if (model === 'OASIS' || model === 'STAY') {
                const pivot = parseInt(pivotVal);
                let priceList;
                if(type === 'manual') {
                    priceList = oasisManualPriceTable[pivot];
                } else {
                    priceList = oasisElectricPriceTable[pivot];
                }
                
                if (priceList && priceList[sIdx] !== undefined) {
                    return priceList[sIdx];
                }
            } 
            return 0;
        }

        // --- ì´ˆê¸°í™” ë° í•¨ìˆ˜ ì •ì˜ ---
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toLocaleDateString('ko-KR');
            document.getElementById('view-date').textContent = today;
            initRegions();
            addRow();
            initConsTable();
        });

        function initRegions() {
            const doSelect = document.getElementById('region-do');
            let opts = '<option value="">ì‹œ/ë„ ì„ íƒ</option>';
            Object.keys(regions).forEach(r => opts += `<option value="${r}">${r}</option>`);
            doSelect.innerHTML = opts;
        }
        
        // í†µí•©ëœ í•¸ë“¤ëŸ¬ (ì§€ì—­ ë³€ê²½ ì‹œ ê³µê¸‰ì ì—…ë°ì´íŠ¸ + ë¹„ìš© ì—…ë°ì´íŠ¸ + ì‹œêµ°êµ¬ ì—…ë°ì´íŠ¸)
        function handleRegionChange(select) {
            const val = select.value;
            const siSelect = document.getElementById('region-si');
            
            // 1. ì‹œ/êµ°/êµ¬ ì—…ë°ì´íŠ¸
            if(val && regions[val]) {
                let sOpts = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
                regions[val].forEach(s => sOpts += `<option value="${s}">${s}</option>`);
                siSelect.innerHTML = sOpts;
                siSelect.disabled = false;
            } else {
                siSelect.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬</option>';
                siSelect.disabled = true;
            }

            // 2. ê³µê¸‰ì ì •ë³´ ì—…ë°ì´íŠ¸
            updateSupplierInfo(val);

            // 3. ë¹„ìš© ì—…ë°ì´íŠ¸
            updateCosts();
        }

        function updateSupplierInfo(regionDo) {
            let supplierData = suppliers.default;
            if (gyeongsangArea.includes(regionDo)) {
                supplierData = suppliers.gyeongsang;
            }

            document.getElementById('supplier-name').textContent = supplierData.name;
            document.getElementById('supplier-biz-no').textContent = supplierData.bizNo;
            document.getElementById('supplier-manager').textContent = supplierData.manager;
            document.getElementById('supplier-phone').textContent = supplierData.phone;
            document.getElementById('supplier-email').textContent = supplierData.email;

            // Footer update
            const footerText = `${supplierData.name} | ë‹´ë‹¹ì: ${supplierData.manager} | ì—°ë½ì²˜: ${supplierData.phone}`;
            document.getElementById('footer-info').textContent = footerText;
        }
        
        function updateCosts() {
            const rDo = document.getElementById('region-do').value;
            if (rDo) {
                updateFreightCost(rDo);
                updateTravelCost(rDo);
            }
        }

        function updateFreightCost(regionDo) {
            let cost = 0;
            if (regionDo === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„') cost = 1800000;
            else if (regionDo.includes('ê²½ìƒ') || regionDo.includes('ë¶€ì‚°') || regionDo.includes('ëŒ€êµ¬') || regionDo.includes('ìš¸ì‚°')) cost = 500000;
            else if (regionDo.includes('ì „ë¼') || regionDo.includes('ì „ë¶') || regionDo.includes('ê´‘ì£¼')) cost = 500000;
            else if (regionDo.includes('ì¶©ì²­') || regionDo.includes('ëŒ€ì „') || regionDo.includes('ì„¸ì¢…')) cost = 400000;
            else if (regionDo.includes('ê°•ì›')) cost = 500000;
            else if (regionDo.includes('ê²½ê¸°') || regionDo.includes('ì¸ì²œ') || regionDo.includes('ì„œìš¸')) cost = 300000;
            
            const consRows = document.querySelectorAll('#cons-tbody tr');
            consRows.forEach(row => {
                const nameInput = row.querySelector('td:nth-child(2) input');
                if (nameInput && nameInput.value === "ìš´ì„") {
                    const priceInput = row.querySelector('.c-price'); 
                    priceInput.value = cost; 
                    calcCons(priceInput);
                }
            });
        }

        function updateTravelCost(regionDo) {
            let cost = 200000; 
            if (regionDo === 'ì„œìš¸íŠ¹ë³„ì‹œ' || regionDo === 'ê²½ê¸°ë„') cost = 0;
            
            const consRows = document.querySelectorAll('#cons-tbody tr');
            consRows.forEach(row => {
                const nameInput = row.querySelector('td:nth-child(2) input');
                const specInput = row.querySelector('td:nth-child(3) input');
                if (nameInput && nameInput.value === "ê²½ë¹„" && specInput && specInput.value === "ì¶œì¥ë¹„") {
                    const priceInput = row.querySelector('.c-price'); priceInput.value = cost; calcCons(priceInput);
                }
            });
        }

        function addRow() {
            const tbody = document.getElementById('est-tbody');
            const tr = document.createElement('tr');
            let prodOpts = '<option value="">ì„ íƒ</option>';
            productCategories.forEach(cat => {
                prodOpts += `<optgroup label="-- ${cat.label} --">`;
                cat.items.forEach(item => { prodOpts += `<option value="${item}">${item}</option>`; });
                prodOpts += `</optgroup>`;
            });
            // ê°€ê²©, ìˆ˜ëŸ‰ í•„ë“œë¥¼ text íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ìŒìˆ˜(-) ì…ë ¥ ìš©ì´í•˜ê²Œ ìˆ˜ì •
            tr.innerHTML = `<td><input type="tel" class="excel-input text-center" placeholder="No"></td><td><select class="excel-input" onchange="handleProdChange(this)">${prodOpts}</select><input type="text" class="excel-input hidden-on-print force-hidden" placeholder="í’ˆëª… ì…ë ¥"></td><td class="spec-cell"><input type="text" class="excel-input text-center" placeholder="ê·œê²©"></td><td><select class="excel-input text-center color-select" onchange="calcRow(this)" disabled><option value="">ì„ íƒ</option><option value="í™”ì´íŠ¸">í™”ì´íŠ¸</option><option value="ì°¨ì½œ">ì°¨ì½œ</option><option value="ê¸°íƒ€">ê¸°íƒ€ (í• ì¦)</option></select></td><td class="option-cell"><input type="text" class="excel-input" placeholder="ì˜µì…˜"></td><td><input type="text" class="excel-input text-center" value="ì‹"></td><td><input type="text" class="excel-input text-center qty" oninput="calcRow(this)" placeholder="0" value="1"></td><td><input type="text" class="excel-input text-right price" oninput="handleManualPrice(this)" placeholder="0" data-base-price="0"></td><td class="text-right px-2"><span class="sum">0</span></td><td class="text-center hidden-on-print"><button onclick="delRow(this)" class="text-red-500 font-bold p-1 text-sm">Ã—</button></td>`;
            tbody.appendChild(tr);
        }

        function handleProdChange(sel) {
            const tr = sel.closest('tr'); const specCell = tr.querySelector('.spec-cell'); const optionCell = tr.querySelector('.option-cell'); const customInput = sel.nextElementSibling; const colorSelect = tr.querySelector('.color-select'); 
            
            // ìƒ‰ìƒ ì˜µì…˜ ë° ë‹¨ìœ„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            colorSelect.innerHTML = '<option value="">ì„ íƒ</option><option value="í™”ì´íŠ¸">í™”ì´íŠ¸</option><option value="ì°¨ì½œ">ì°¨ì½œ</option><option value="ê¸°íƒ€">ê¸°íƒ€ (í• ì¦)</option>';
            const otherOption = colorSelect.querySelector('option[value="ê¸°íƒ€"]');
            colorSelect.disabled = false; colorSelect.value = '';
            tr.querySelector('td:nth-child(6) input').value = "ì‹";
            
            // "ì§ì ‘ ì…ë ¥" or "custom" handling
            if(sel.value === 'custom' || sel.value === 'ì§ì ‘ ì…ë ¥') { 
                sel.classList.add('force-hidden'); 
                customInput.classList.remove('force-hidden'); 
                customInput.focus(); 
                
                // Clear cells but keep as input
                specCell.innerHTML = '<input type="text" class="excel-input text-center" placeholder="ê·œê²©">'; 
                optionCell.innerHTML = '<input type="text" class="excel-input" placeholder="ì˜µì…˜ ì…ë ¥">'; 
                
                // Update "ê¸°íƒ€" option to "+15%"
                otherOption.textContent = "ê¸°íƒ€ (+15%)"; 
                colorSelect.disabled = false; 
                return; 
            } else { 
                sel.classList.remove('force-hidden'); 
                customInput.classList.add('force-hidden'); 
            }
            
            const isOasis = sel.value.includes("OASIS"); 
            const isGlass = sel.value.includes("Glass");
            const isDeck = sel.value.includes("ìŠ¤í†¤ë°í¬");
            
            if (isOasis || isGlass) {
                otherOption.textContent = "ê¸°íƒ€ (+15%)"; 
            } else if (!isDeck) { 
                otherOption.textContent = "ê¸°íƒ€ (í• ì¦)"; 
                colorSelect.disabled = true; 
            }

            if (isOasis) {
                let pivotOpts = '<option value="">ì„ íƒ</option>'; let pivotList = [];
                const isManual = sel.value.includes("ìˆ˜ë™"); 
                pivotList = isManual ? stayManualPivots : stayElectricPivots;
                
                pivotList.forEach(p => pivotOpts += `<option value="${p}">${p}</option>`);
                let heightSelectHtml = `<div class="spec-row"><span class="spec-label">H</span><select class="excel-input spec-input spec-height" onchange="calcPergola(this)"><option value="3000ì´í•˜">3000ì´í•˜</option><option value="6000ì´í•˜">6000ì´í•˜ (+100ë§Œ)</option></select></div>`;
                
                specCell.innerHTML = `<div class="spec-container"><div class="spec-row"><span class="spec-label">Span</span><input type="tel" class="excel-input spec-input spec-span" placeholder="ì…ë ¥(mm)" oninput="calcPergola(this)"></div><div class="spec-row"><span class="spec-label">Pivot</span><select class="excel-input spec-input spec-pivot" onchange="calcPergola(this)">${pivotOpts}</select></div>${heightSelectHtml}</div>`;
                
                optionCell.innerHTML = `<div class="option-container"><label class="option-row option-label"><input type="checkbox" class="opt-led" onchange="calcRow(this)"><span>LED ì‹±ê¸€ ë¼ì¸ë“±</span></label><div class="option-row"><label class="option-label"><input type="checkbox" class="opt-pillar-chk" onchange="togglePillarInput(this)"><span>ê¸°ë‘¥ ì¶”ê°€</span></label><input type="tel" class="option-qty-input opt-pillar" placeholder="0" min="0" disabled oninput="calcRow(this)"></div></div>`; 
            } else if (sel.value === "Glass Sliding") {
                specCell.innerHTML = `<select class="excel-input text-center glass-spec" onchange="calcRow(this)"><option value="2500_under">2500mm ë¯¸ë§Œ</option><option value="2500_over">2500mm ì´ìƒ</option></select>`; 
                optionCell.innerHTML = `<input type="text" class="excel-input" value="" readonly>`;
            } else if (sel.value === "Fix Glass") {
                specCell.innerHTML = '<input type="text" class="excel-input text-center" placeholder="ê·œê²© ì…ë ¥">'; 
                optionCell.innerHTML = `<input type="text" class="excel-input" value="ì‹œê³µë¹„ë³„ë„" readonly>`;
            } else if (isDeck) {
                specCell.innerHTML = '<input type="text" class="excel-input text-center" value="600*600" readonly>'; 
                optionCell.innerHTML = `<input type="text" class="excel-input text-center" value="-" readonly>`;
                tr.querySelector('td:nth-child(6) input').value = "m2";
                colorSelect.innerHTML = '<option value="">ì„ íƒ</option><option value="ì—°ê·¸ë ˆì´">ì—°ê·¸ë ˆì´</option><option value="ì—°ë² ì´ì§€">ì—°ë² ì´ì§€</option><option value="ì°¨ì½œ">ì°¨ì½œ</option>';
                colorSelect.disabled = false;
            } else {
                // Restore default cells for other items
                specCell.innerHTML = '<input type="text" class="excel-input text-center" placeholder="ê·œê²©">'; 
                optionCell.innerHTML = '<input type="text" class="excel-input" placeholder="ì˜µì…˜ ì…ë ¥">'; 
            }
            tr.querySelector('.price').value = ''; tr.querySelector('.price').dataset.basePrice = 0; calcRow(sel);
        }

        function togglePillarInput(chk) { const input = chk.closest('.option-row').querySelector('.opt-pillar'); input.disabled = !chk.checked; if(!chk.checked) input.value = ''; calcRow(chk); }
        function handleManualPrice(el) { el.dataset.basePrice = el.value; calcRow(el); }
        
        function calcPergola(el) {
            const tr = el.closest('tr'); const prodName = tr.querySelector('td:nth-child(2) select').value;
            const span = parseInt(tr.querySelector('.spec-span')?.value) || 0; const pivot = parseInt(tr.querySelector('.spec-pivot')?.value) || 0; const heightVal = tr.querySelector('.spec-height')?.value;
            if (span > 0 && pivot > 0) {
                let model = "STAY", type = "manual";
                if(prodName.includes("OASIS")) model = "OASIS"; 
                if(prodName.includes("ì „ë™")) type = "electric";
                
                let basePrice = calculatePergolaPrice(model, type, span, pivot);
                if (heightVal === '6000ì´í•˜') basePrice += 1000000;
                const priceInput = tr.querySelector('.price'); priceInput.dataset.basePrice = basePrice; calcRow(el);
            }
        }

        function calcRow(el) {
            const tr = el.closest('tr'); const priceInput = tr.querySelector('.price'); const qtyInput = tr.querySelector('.qty'); const colorSelect = tr.querySelector('td:nth-child(4) select'); 
            const prodSelect = tr.querySelector('td:nth-child(2) select');
            
            // Check if "Direct Input" mode
            let prodName = prodSelect.value;
            if (prodSelect.classList.contains('force-hidden')) {
                 prodName = 'ì§ì ‘ ì…ë ¥';
            }

            let basePrice = parseFloat(priceInput.dataset.basePrice);
            if (isNaN(basePrice)) basePrice = 0;
            if (priceInput.value === '-') basePrice = 0; // ë§ˆì´ë„ˆìŠ¤ë§Œ ì…ë ¥ ì‹œ ê³„ì‚° ì˜¤ë¥˜ ë°©ì§€
            
            if (prodName === "Glass Sliding") { 
                const specVal = tr.querySelector('.glass-spec')?.value; 
                if (specVal === '2500_over') basePrice = 600000; 
                else basePrice = 500000; 
            } else if (prodName === "Fix Glass") {
                basePrice = 150000;
            } else if (prodName === "ìŠ¤í†¤ë°í¬ (+í˜ë°ìŠ¤íƒˆ)") {
                basePrice = 110000;
            } else if (prodName === "ìŠ¤í†¤ë°í¬ (+ê°ê´€)") {
                basePrice = 150000;
            }
            
            if (colorSelect.value === 'ê¸°íƒ€') {
                if (prodName.includes("OASIS") || prodName.includes("Glass") || prodName === 'ì§ì ‘ ì…ë ¥') basePrice = Math.round(basePrice * 1.15);
            }
            let optionAddon = 0;
            if (prodName.includes("OASIS")) { 
                const isManual = prodName.includes("ìˆ˜ë™"); 
                if (tr.querySelector('.opt-led')?.checked) optionAddon += isManual ? 1000000 : 500000; 
                if (tr.querySelector('.opt-pillar-chk')?.checked) optionAddon += (parseInt(tr.querySelector('.opt-pillar')?.value)||0) * 500000; 
            }
            
            let finalUnitPrice = basePrice + optionAddon;
            
            // í’ˆëª© ì„ íƒì„ í†µí•œ ìë™ ë‹¨ê°€ê°€ ì•„ë‹Œ, ì§ì ‘ ì…ë ¥ ìƒíƒœì¸ ê²½ìš° ë®ì–´ì“°ê¸° ë°©ì§€ (ë§ˆì´ë„ˆìŠ¤ ë“± íƒ€ì´í•‘ ì›í™œ)
            if (prodSelect.classList.contains('force-hidden') || prodName === 'ì§ì ‘ ì…ë ¥' || prodName === 'custom') {
                 // ê·¸ëŒ€ë¡œ ë‘ 
            } else {
                 priceInput.value = finalUnitPrice !== 0 ? finalUnitPrice : '';
            }

            const qty = parseFloat(qtyInput.value) || 0; 
            const sum = finalUnitPrice * qty; 
            tr.querySelector('.sum').textContent = sum.toLocaleString(); 
            
            syncAutoCalcItems();
        }

        function syncAutoCalcItems() {
            let oasisTotalQty = 0;
            let glassTotalQty = 0;
            let fixGlassQty = 0;
            let stoneDeckPedestalQty = 0;
            let stoneDeckTubeQty = 0;
            let hasManualOasisLed = false;
            
            const prodRows = document.querySelectorAll('#est-tbody tr');
            prodRows.forEach(row => {
                const prodSelect = row.querySelector('td:nth-child(2) select');
                const qtyInput = row.querySelector('.qty');
                if (prodSelect && qtyInput) {
                    const prodName = prodSelect.value;
                    const qty = parseFloat(qtyInput.value) || 0;
                    if (prodName.includes("OASIS")) oasisTotalQty += qty;
                    if (prodName.includes("Glass Sliding")) glassTotalQty += qty;
                    if (prodName.includes("Fix Glass")) fixGlassQty += qty;
                    if (prodName === "ìŠ¤í†¤ë°í¬ (+í˜ë°ìŠ¤íƒˆ)") stoneDeckPedestalQty += qty;
                    if (prodName === "ìŠ¤í†¤ë°í¬ (+ê°ê´€)") stoneDeckTubeQty += qty;
                    
                    if (prodName.includes("OASIS (ìˆ˜ë™)")) {
                        if (row.querySelector('.opt-led')?.checked) {
                            hasManualOasisLed = true;
                        }
                    }
                }
            });

            let fixGlassConsFound = false;
            let glassConsFound = false;
            let oasisConsFound = false;
            let stoneDeckPedestalConsFound = false;
            let stoneDeckTubeConsFound = false;
            
            const existingConsRows = document.querySelectorAll('#cons-tbody tr');
            existingConsRows.forEach(row => {
                const nameInput = row.querySelector('td:nth-child(2) input');
                const specInput = row.querySelector('td:nth-child(3) input');
                if (nameInput) {
                    if (nameInput.value === "Fix Glass") fixGlassConsFound = true;
                    if (nameInput.value === "Glass Sliding") glassConsFound = true;
                    if (nameInput.value === "OASIS") oasisConsFound = true;
                    
                    if (nameInput.value === "ìŠ¤í†¤ë°í¬") {
                        if (specInput && specInput.value.includes("í˜ë°ìŠ¤íƒˆ")) stoneDeckPedestalConsFound = true;
                        if (specInput && specInput.value.includes("ê°ê´€")) stoneDeckTubeConsFound = true;
                    }
                }
            });
            
            if (fixGlassQty > 0 && !fixGlassConsFound) {
                addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'Fix Glass', spec: 'ì‹œê³µë¹„', price: 30000 });
            }
            if (glassTotalQty > 0 && !glassConsFound) {
                addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'Glass Sliding', spec: 'ì‹œê³µë¹„', price: 0 });
            }
            if (oasisTotalQty > 0 && !oasisConsFound) {
                addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'OASIS', spec: 'ì¸ê±´ë¹„/ë¶€ìì¬', price: 800000 });
            }
            if (stoneDeckPedestalQty > 0 && !stoneDeckPedestalConsFound) {
                addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'ìŠ¤í†¤ë°í¬', spec: 'ìŠ¤í†¤ë°í¬ + í˜ë°ìŠ¤íƒˆ ì‹œê³µ', price: 40000 });
            }
            if (stoneDeckTubeQty > 0 && !stoneDeckTubeConsFound) {
                addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'ìŠ¤í†¤ë°í¬', spec: 'ìŠ¤í†¤ë°í¬ + ê°ê´€ ì‹œê³µ', price: 50000 });
            }

            const consRows = document.querySelectorAll('#cons-tbody tr');
            consRows.forEach(row => {
                const nameInput = row.querySelector('td:nth-child(2) input');
                const qtyInput = row.querySelector('.c-qty');
                const priceInput = row.querySelector('.c-price');
                const specInput = row.querySelector('td:nth-child(3) input');
                
                if (nameInput && nameInput.value === "OASIS") {
                    if (qtyInput) qtyInput.value = oasisTotalQty;
                    priceInput.value = 800000;
                    calcCons(qtyInput, false);
                }

                if (nameInput && nameInput.value === "Glass Sliding") {
                    if (glassTotalQty > 0) {
                        if (glassTotalQty < 9) {
                            qtyInput.value = 1;
                            priceInput.value = 600000;
                            if(specInput) specInput.value = "ê¸°ë³¸ ì‹œê³µë¹„ (9ì§ ë¯¸ë§Œ)";
                        } else {
                            qtyInput.value = glassTotalQty;
                            priceInput.value = 70000;
                            if(specInput) specInput.value = "ì§ë‹¹ ì‹œê³µë¹„";
                        }
                    } else {
                        qtyInput.value = 0;
                        priceInput.value = 0;
                    }
                    calcCons(qtyInput, false);
                }

                if (nameInput && nameInput.value === "Fix Glass") {
                    if (fixGlassQty > 0) {
                        qtyInput.value = fixGlassQty;
                        priceInput.value = 30000;
                    } else {
                        qtyInput.value = 0;
                        priceInput.value = 0;
                    }
                    calcCons(qtyInput, false);
                }

                if (nameInput && nameInput.value === "ìš´ì„") {
                    let requiredTrucks = Math.ceil(oasisTotalQty / 2);
                    if (glassTotalQty > 0) requiredTrucks += 1;
                    if (qtyInput) qtyInput.value = requiredTrucks > 0 ? requiredTrucks : 1; 
                    calcCons(qtyInput, false);
                }

                if (nameInput && nameInput.value === "ì–‘ì¤‘ë¹„") {
                    let liftingCount = 1; 
                    if (glassTotalQty > 0) liftingCount += 1;
                    if (qtyInput) qtyInput.value = liftingCount;
                    calcCons(qtyInput, false);
                }

                // ìŠ¤í†¤ë°í¬ ìˆ˜ëŸ‰(m2) ìë™ ì—°ë™
                if (nameInput && nameInput.value === "ìŠ¤í†¤ë°í¬") {
                    if (specInput && specInput.value.includes("í˜ë°ìŠ¤íƒˆ")) {
                        if (stoneDeckPedestalQty > 0) {
                            if(qtyInput) qtyInput.value = stoneDeckPedestalQty;
                            priceInput.value = 40000;
                            row.querySelector('td:nth-child(4) input').value = "m2";
                        } else {
                            if(qtyInput) qtyInput.value = 0;
                            priceInput.value = 0;
                        }
                        calcCons(qtyInput, false);
                    }
                    if (specInput && specInput.value.includes("ê°ê´€")) {
                        if (stoneDeckTubeQty > 0) {
                            if(qtyInput) qtyInput.value = stoneDeckTubeQty;
                            priceInput.value = 50000;
                            row.querySelector('td:nth-child(4) input').value = "m2";
                        } else {
                            if(qtyInput) qtyInput.value = 0;
                            priceInput.value = 0;
                        }
                        calcCons(qtyInput, false);
                    }
                }
            });
            
            const discountArea = document.getElementById('discount-message-area');
            const existingWarning = discountArea.querySelector('.warning-text');
            if (existingWarning) existingWarning.remove();
            
            if (hasManualOasisLed) {
                const warningMsg = document.createElement('div');
                warningMsg.className = 'warning-text';
                warningMsg.innerHTML = '<strong>ì£¼ì˜:</strong> ìˆ˜ë™(Manual) ì„ íƒ ì‹œ LED ìˆ˜ì‹ ê¸°, SMPS, ë¦¬ëª¨ì»¨, ë¶€ì†í•¨ ë“±ì„ ë³„ë„ êµ¬ë§¤í•´ì•¼ í•˜ë¯€ë¡œ LED ë¹„ìš©ì´ ë†’ê²Œ ì¸¡ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì „ë™(Electric)ì„ ì„ íƒí•˜ì‹œë©´ í†µí•© ë¶€í’ˆìœ¼ë¡œ ë” í•©ë¦¬ì ì¸ ë¹„ìš©ì´ ì±…ì •ë©ë‹ˆë‹¤.';
                discountArea.appendChild(warningMsg);
            }

            sortConsRows();
            calcTotal(true);
        }

        function sortConsRows() {
            const tbody = document.getElementById('cons-tbody');
            const rows = Array.from(tbody.children);
            
            rows.sort((a, b) => {
                const aName = getConsRowName(a);
                const bName = getConsRowName(b);
                const aCat = a.querySelector('td:nth-child(1) input').value;
                const bCat = b.querySelector('td:nth-child(1) input').value;

                const getPriority = (cat, name) => {
                    if (name === "OASIS" || name === "Glass Sliding" || name === "Fix Glass" || name === "ìŠ¤í†¤ë°í¬") return 1;
                    if (name === "ê¸°ì´ˆì„" || name === "ê²½ë¹„") return 2;
                    if (cat === "ìì¬ ë°˜ì…ë¹„") return 3;
                    if (cat === "ê°„ì ‘ ê³µì‚¬ë¹„") return 4;
                    if (cat === "ìì²´ê³µì‚¬ë¹„") return 5;
                    return 6;
                };

                return getPriority(aCat, aName) - getPriority(bCat, bName);
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function getConsRowName(row) {
            const select = row.querySelector('td:nth-child(2) select');
            if (select) return select.value;
            const input = row.querySelector('td:nth-child(2) input');
            return input ? input.value : "";
        }

        function initConsTable() { defaultConsItems.forEach(item => addConsRow(item)); }

        function addConsRow(item = null) {
            const tbody = document.getElementById('cons-tbody'); const tr = document.createElement('tr');
            const cat = item ? item.cat : ''; const name = item ? item.name : ''; const spec = item ? item.spec : ''; const price = item && item.price ? item.price : ''; const isPercent = item && item.isPercent; const isProductSelect = item && item.isProductSelect;
            
            let nameField = `<input type="text" class="excel-input ${isPercent ? 'auto-calc-field name-field' : ''}" value="${name}" placeholder="í•­ëª©ëª…" ${isPercent ? 'readonly' : ''}>`;

            // c-qtyì™€ c-price í•„ë“œë¥¼ text íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ìŒìˆ˜ ì²˜ë¦¬ ì›í™œí•˜ê²Œ í•¨
            tr.innerHTML = `<td><input type="text" class="excel-input text-center" value="${cat}" placeholder="êµ¬ë¶„"></td><td>${nameField}</td><td>${isProductSelect ? '<input type="text" class="excel-input" value="ì¸ê±´ë¹„/ë¶€ìì¬" readonly>' : `<input type="text" class="excel-input" value="${spec}" placeholder="ìƒì„¸ë‚´ìš©">`}</td><td><input type="text" class="excel-input text-center" value="ì‹"></td><td><input type="text" class="excel-input text-center c-qty" oninput="calcCons(this)" placeholder="1" value="1" ${isPercent ? 'readonly' : ''}></td><td><input type="text" class="excel-input text-right c-price ${isPercent ? 'auto-calc-field' : ''}" oninput="calcCons(this)" placeholder="0" value="${price}" ${isPercent ? 'readonly' : ''}></td><td class="text-right px-2"><span class="c-sum">0</span></td><td class="text-center hidden-on-print"><button onclick="delRow(this)" class="text-red-500 font-bold p-1 text-sm">Ã—</button></td>`;
            let insertIndex = -1; if (cat) { const rows = Array.from(tbody.children); for(let i = rows.length - 1; i >= 0; i--) { if(rows[i].querySelector('td:nth-child(1) input').value === cat) { insertIndex = i; break; } } }
            if(insertIndex !== -1) tbody.children[insertIndex].after(tr); else tbody.appendChild(tr);
            if(name === "í•­ëª©ëª…") { 
                const nameCell = tr.querySelector('td:nth-child(2)'); 
                let consProdOpts = '<option value="">ì„ íƒ</option>'; 
                productCategories.forEach(cat => { consProdOpts += `<optgroup label="-- ${cat.label} --">`; cat.items.forEach(item => { consProdOpts += `<option value="${item}">${item}</option>`; }); consProdOpts += `</optgroup>`; }); 
                nameCell.innerHTML = `<select class="excel-input" onchange="handleConsProdChange(this)">${consProdOpts}</select><input type="text" class="excel-input hidden-on-print force-hidden" placeholder="í•­ëª©ëª…">`; 
            }
            if(price || isPercent) calcCons(tr.querySelector('.c-price'), false);
        }

        // --- NEW BUTTON FUNCTIONS ---
        function addGenericDirectConsRow() {
            addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: '', spec: '', price: 0 });
        }

        function addMeasurementRow() { addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'ê²½ë¹„', spec: 'ì‹¤ì¸¡ë¹„', price: 200000 }); }
        function addFoundationRow() { addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'ê¸°ì´ˆì„', spec: 'ìì¬/ì‹œê³µ', price: 200000 }); }
        function addLiftingRow() { 
            // Manual add Lifting cost. Logic will handle quantity.
            addConsRow({ cat: 'ìì¬ ë°˜ì…ë¹„', name: 'ì–‘ì¤‘ë¹„', spec: 'ì‚¬ë‹¤ë¦¬ì°¨/ìŠ¤ì¹´ì´', price: 300000 });
            syncAutoCalcItems();
        }
        function addDirectConsRow() { 
            // OASIS auto-add
            addConsRow({ cat: 'ì§ì ‘ ê³µì‚¬ë¹„', name: 'OASIS', spec: 'ì¸ê±´ë¹„/ë¶€ìì¬', price: 800000 }); 
            syncAutoCalcItems();
        }
        function addDeckRow() { 
            addConsRow({ cat: 'ìì²´ê³µì‚¬ë¹„', name: 'ë°í¬', spec: 'ë°í¬ê³µì‚¬ ì¼ì²´ (m2)', price: 180000 });
            const textarea = document.getElementById('remarks-area');
            textarea.value += (textarea.value ? "\n" : "") + "- ë°í¬ ê³µì‚¬ì˜ ê²½ìš° ê¸°ë³¸ ê³µì‚¬ ë¹„ìš©ìœ¼ë¡œ ìì¬ì„ íƒ, í˜„ì¥ ìƒí™©ì— ë”°ë¼ ê²¬ì ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        }
        function addIndirectConsRow() {
            addConsRow({ cat: "ê°„ì ‘ ê³µì‚¬ë¹„", name: "ê³µê³¼ì¡ë¹„", spec: "ê¸°íƒ€ ê²½ë¹„", isPercent: true });
            addConsRow({ cat: "ê°„ì ‘ ê³µì‚¬ë¹„", name: "ê°ë¦¬ë¹„", spec: "ê¸°íƒ€ ê²½ë¹„", isPercent: true });
            calcTotal();
        }
        
        function handleConsProdChange(sel) { /* ... */ }

        function calcCons(el, triggerTotal = true) { 
            const tr = el.closest('tr'); 
            const qty = parseFloat(tr.querySelector('.c-qty').value) || 0; 
            const price = parseFloat(tr.querySelector('.c-price').value) || 0; 
            const sum = qty * price; 
            tr.querySelector('.c-sum').textContent = sum.toLocaleString(); 
            if(triggerTotal) calcTotal(false);
        }
        
        function calcTotal(triggerPercentUpdate = true) {
            let prodTotal = 0; document.querySelectorAll('#est-tbody .sum').forEach(el => prodTotal += parseFloat(el.textContent.replace(/,/g,''))||0);
            
            let hasOverhead = false;
            let hasSupervision = false;
            
            // Check for overhead rows
            const consRows = document.querySelectorAll('#cons-tbody tr'); 
            consRows.forEach(row => { 
                const nameInput = row.querySelector('td:nth-child(2) input'); 
                const name = nameInput ? nameInput.value : ''; 
                if (name === "ê³µê³¼ì¡ë¹„") hasOverhead = true;
                if (name === "ê°ë¦¬ë¹„") hasSupervision = true;
            });

            if (triggerPercentUpdate) { 
                consRows.forEach(row => { 
                    const nameInput = row.querySelector('td:nth-child(2) input'); 
                    const name = nameInput ? nameInput.value : ''; 
                    
                    if (name === "ê³µê³¼ì¡ë¹„") { 
                        const priceInput = row.querySelector('.c-price'); 
                        const newVal = Math.round(prodTotal * 0.05); 
                        priceInput.value = newVal; 
                        const qty = parseFloat(row.querySelector('.c-qty').value) || 0; 
                        row.querySelector('.c-sum').textContent = (qty * newVal).toLocaleString(); 
                    }
                    if (name === "ê°ë¦¬ë¹„") {
                        const priceInput = row.querySelector('.c-price'); 
                        const newVal = Math.round(prodTotal * 0.05); 
                        priceInput.value = newVal; 
                        const qty = parseFloat(row.querySelector('.c-qty').value) || 0; 
                        row.querySelector('.c-sum').textContent = (qty * newVal).toLocaleString(); 
                    }
                }); 
            }
            
            const discountArea = document.getElementById('discount-message-area');
            const warning = discountArea.querySelector('.warning-text');
            discountArea.innerHTML = '';
            // OASIS ìˆ˜ë™ ê²½ê³  ë¬¸êµ¬ëŠ” ìœ ì§€
            if(warning) discountArea.appendChild(warning);
            
            // [ìˆ˜ì •ë¨] ê°„ì ‘ê³µì‚¬ë¹„ í• ì¸ ì•ˆë‚´ ë¬¸êµ¬ ìƒì„± ë¡œì§ ì‚­ì œ

            let consTotal = 0; document.querySelectorAll('#cons-tbody .c-sum').forEach(el => consTotal += parseFloat(el.textContent.replace(/,/g,''))||0);
            const totalSupply = prodTotal + consTotal;
            // í• ì¸ ì—†ìŒ
            const afterDiscount = totalSupply;
            const tax = Math.round(afterDiscount * 0.1); 
            const grandTotal = afterDiscount + tax;
            document.getElementById('val-prod-sum').textContent = prodTotal.toLocaleString(); 
            document.getElementById('val-cons-sum').textContent = consTotal.toLocaleString(); 
            document.getElementById('val-supply').textContent = totalSupply.toLocaleString(); 
            document.getElementById('val-tax').textContent = tax.toLocaleString(); 
            document.getElementById('val-total').textContent = grandTotal.toLocaleString();
        }
        function delRow(btn) { 
            btn.closest('tr').remove(); 
            syncAutoCalcItems(); 
        }

        async function saveAsPDF() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const hiddenContainer = document.getElementById('pdf-hidden-container');
                hiddenContainer.innerHTML = ''; 

                const p1 = document.getElementById('capture-area');
                const clone1 = p1.cloneNode(true);
                syncInputValues(p1, clone1);

                hiddenContainer.appendChild(clone1);
                hiddenContainer.classList.add('pdf-mode');

                await new Promise(resolve => setTimeout(resolve, 300));

                const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                const captureOptions = { scale: 2, useCORS: true, logging: false, width: 1200, windowWidth: 1200, backgroundColor: '#ffffff' };

                const canvas1 = await html2canvas(clone1, captureOptions);
                const imgData1 = canvas1.toDataURL('image/png');
                const imgHeight1 = (canvas1.height * pageWidth) / canvas1.width;
                
                doc.addImage(imgData1, 'PNG', 0, 0, pageWidth, Math.min(imgHeight1, pageHeight));

                const regionDo = document.getElementById('region-do').value || 'ì§€ì—­';
                const regionSi = document.getElementById('region-si').value || '';
                const phone = document.getElementById('cust-phone').value || '';
                const phoneLast4 = phone.length >= 4 ? phone.slice(-4) : phone;
                let name = document.getElementById('cust-name').value;
                if (!name || name.trim() === '') name = 'VIP'; 
                const date = new Date().toISOString().slice(2,10).replace(/-/g,'');
                
                const safeRegionDo = regionDo.trim();
                const safeRegionSi = regionSi.trim();
                // TC_ ì ‘ë‘ì–´ ì¶”ê°€
                const fileName = `TC_${safeRegionDo} ${safeRegionSi} ${phoneLast4} ${name}_${date}.pdf`.trim();

                doc.save(fileName);

            } catch (err) {
                console.error(err);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + err.message);
            } finally {
                document.getElementById('pdf-hidden-container').innerHTML = '';
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }
        
        function syncInputValues(originalDom, clonedDom) {
            const originalInputs = originalDom.querySelectorAll('input, select, textarea');
            const clonedInputs = clonedDom.querySelectorAll('input, select, textarea');
            
            originalInputs.forEach((input, index) => {
                const clone = clonedInputs[index];
                if (!clone) return;

                if (input.type === 'checkbox' || input.type === 'radio') {
                    clone.checked = input.checked;
                    if(input.checked) {
                        const span = document.createElement('span');
                        span.textContent = 'âœ” ';
                        span.style.fontWeight = 'bold';
                        span.style.marginRight = '4px';
                        clone.parentNode.insertBefore(span, clone);
                        clone.style.display = 'none';
                    } else {
                         if(clone.parentElement.tagName === 'LABEL') clone.parentElement.style.display = 'none';
                         else clone.style.display = 'none';
                    }
                } else if (input.tagName === 'SELECT') {
                    const selectedText = input.options[input.selectedIndex] ? input.options[input.selectedIndex].text : '';
                    const span = document.createElement('span');
                    span.textContent = selectedText;
                    span.className = 'pdf-text-value';
                    span.style.cssText = window.getComputedStyle(input).cssText;
                    span.style.border = 'none';
                    span.style.padding = '0';
                    span.style.width = 'auto';
                    clone.parentNode.replaceChild(span, clone);
                } else {
                    const span = document.createElement('span');
                    span.textContent = input.value;
                    span.className = 'pdf-text-value';
                    span.style.cssText = window.getComputedStyle(input).cssText;
                    span.style.border = 'none';
                    span.style.background = 'transparent';
                    if(input.tagName === 'TEXTAREA') {
                        span.style.whiteSpace = 'pre-wrap';
                        span.style.display = 'block';
                    }
                    clone.parentNode.replaceChild(span, clone);
                }
            });
            
            // Copy dynamic content (supplier info including footer)
            // Use querySelector because originalDom is a Div element, not Document
            const supplierFields = ['supplier-name', 'supplier-biz-no', 'supplier-manager', 'supplier-phone', 'supplier-email', 'footer-info'];
            supplierFields.forEach(id => {
                 const originalEl = originalDom.querySelector('#' + id);
                 const clonedEl = clonedDom.querySelector('#' + id);
                 if(originalEl && clonedEl) {
                     clonedEl.textContent = originalEl.textContent;
                 }
            });

            const originalMsgs = originalDom.querySelectorAll('.discount-text');
            const originalWarnings = originalDom.querySelectorAll('.warning-text');
            const clonedMsgArea = clonedDom.querySelector('#discount-message-area');
            if(clonedMsgArea) {
                 clonedMsgArea.innerHTML = '';
                 if (originalWarnings.length > 0) {
                     originalWarnings.forEach(msg => clonedMsgArea.appendChild(msg.cloneNode(true)));
                 }
                 if (originalMsgs.length > 0) {
                     originalMsgs.forEach(msg => clonedMsgArea.appendChild(msg.cloneNode(true)));
                 }
            }
        }
    </script>
</body>
</html>